plugins {
  id "io.micronaut.application" version "1.0.0.RC12"
}
repositories {
    mavenLocal()
    jcenter()
    maven {
        url("https://dl.bintray.com/fnproject/fnproject")
    }

}

micronaut {
    version "2.1.0.BUILD-SNAPSHOT"
}

version "0.0.2"

dependencies {
    implementation("io.micronaut.oraclecloud:micronaut-oraclecloud-sdk")
    implementation("io.micronaut.oraclecloud:micronaut-oraclecloud-function")
    implementation "com.oracle.oci.sdk:oci-java-sdk-objectstorage"
    runtimeOnly 'org.slf4j:slf4j-simple'
    runtimeOnly 'com.fnproject.fn:runtime'
    testImplementation 'com.fnproject.fn:testing-junit4'
    testImplementation("io.micronaut.test:micronaut-test-junit5")
    testRuntimeOnly("org.junit.jupiter:junit-jupiter-engine")
    testAnnotationProcessor "io.micronaut:micronaut-inject-java"
}

mainClassName = "com.fnproject.fn.runtime.EntryPoint"

nativeImage {
  args('--static',
       '-Dfn.handler=example.ListBucketsFunction::handleRequest',
       "--initialize-at-build-time=example",
       "-J-Xmx8g")
}

dockerBuild {
    images = ["us-ashburn-1.ocir.io/cloudnative-devrel/graemerocher/list-buckets:$project.version"]
}

dockerBuildNative {
    images = ["us-ashburn-1.ocir.io/cloudnative-devrel/graemerocher/list-buckets-native:$project.version"]
}

// deploy with:
// ./gradlew dockerPush
// fn create function acme-func list-buckets us-ashburn-1.ocir.io/cloudnative-devrel/graemerocher/list-buckets:0.0.1 --memory 512 --timeout 120
dockerfile {
  buildStrategy = io.micronaut.gradle.docker.DockerBuildStrategy.ORACLE_FUNCTION
  defaultCommand = "example.ListBucketsFunction::handleRequest"
}

dockerfileNative {
  args('-XX:MaximumHeapSizePercent=80')
  buildStrategy = io.micronaut.gradle.docker.DockerBuildStrategy.ORACLE_FUNCTION
  defaultCommand = "example.ListBucketsFunction::handleRequest"
}
